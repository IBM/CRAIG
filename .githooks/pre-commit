#!/bin/sh

formatted_print() {
  printf "\n%s" "##############################################################################"
  printf "\n%s" "# > pre-commit: $1"
  printf "\n%s" "##############################################################################"
}

# run pretty
formatted_print "Prettifying Code"
npm run pretty

# checking if npm install throws any errors or warnings
formatted_print "Installing Dependencies"
if npm run i-all | tee /dev/tty | grep -e 'npm WARN' -e 'npm ERR' > /dev/null; then
  formatted_print "Commit failed during install" > /dev/stderr
  exit 1
fi

# checking for failed unit tests
formatted_print "Running Unit Tests"
TEST_OUTPUT=$(npm run coverage)
GREP_OUTPUT=$(echo "$TEST_OUTPUT" | tee /dev/tty | grep failing) > /dev/null
if [[ -n "$GREP_OUTPUT" ]]; then
  formatted_print "Failing unit test(s) found"
  echo "$TEST_OUTPUT" | awk '/'"$GREP_OUTPUT"'/ {flag=1;next} /----------------------------|---------|----------|---------|---------|-------------------/ {flag=0} flag {print}'
  formatted_print "Commit failed during unit tests" > /dev/stderr
  exit 1
fi

# check for failing build
formatted_print Running Build
if ! npm run pre-commit-build | tee /dev/tty | grep 'Compiled successfully.' > /dev/null; then
  formatted_print "Commit failed on build" > /dev/stderr
  exit 1
fi

formatted_print "pre-commit completed successfully!"
