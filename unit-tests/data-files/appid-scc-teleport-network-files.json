{
  "versions.tf": "##############################################################################\n# Terraform Providers\n##############################################################################\n\nterraform {\n  required_providers {\n    ibm = {\n      source  = \"IBM-Cloud/ibm\"\n      version = \"~>1.43.0\"\n    }\n  }\n  required_version = \">=1.3\"\n}\n\n##############################################################################\n",
  "main.tf": "##############################################################################\n# IBM Cloud Provider\n##############################################################################\n\nprovider \"ibm\" {\n  ibmcloud_api_key = var.ibmcloud_api_key\n  region           = \"us-south\"\n  ibmcloud_timeout = 60\n}\n\n#############################################################################\n",
  "variables.tf": "##############################################################################\n# Variables\n##############################################################################\n\nvariable \"ibmcloud_api_key\" {\n  description = \"The IBM Cloud platform API key needed to deploy IAM enabled resources.\"\n  type        = string\n  sensitive   = true\n}\n\nvariable \"slz_ssh_key_public_key\" {\n  description = \"Public SSH Key Value for Slz SSH Key\"\n  type        = string\n  sensitive   = true\n  default     = \"public-key\"\n}\n\n##############################################################################\n",
  "vpc.tf": "##############################################################################\n# Management VPC\n##############################################################################\n\nresource \"ibm_is_vpc\" \"management_vpc\" {\n  name                        = \"slz-management-vpc\"\n  resource_group              = ibm_resource_group.slz_management_rg.id\n  address_prefix_management   = \"manual\"\n  default_network_acl_name    = null\n  default_security_group_name = null\n  default_routing_table_name  = null\n  tags = [\n    \"slz\",\n    \"landing-zone\"\n  ]\n}\n\nresource \"ibm_is_vpc_address_prefix\" \"management_vsi_zone_1_prefix\" {\n  name = \"slz-management-vsi-zone-1\"\n  vpc  = ibm_is_vpc.management_vpc.id\n  zone = \"us-south-1\"\n  cidr = \"10.10.10.0/24\"\n}\n\nresource \"ibm_is_vpc_address_prefix\" \"management_vsi_zone_2_prefix\" {\n  name = \"slz-management-vsi-zone-2\"\n  vpc  = ibm_is_vpc.management_vpc.id\n  zone = \"us-south-2\"\n  cidr = \"10.10.20.0/24\"\n}\n\nresource \"ibm_is_vpc_address_prefix\" \"management_vsi_zone_3_prefix\" {\n  name = \"slz-management-vsi-zone-3\"\n  vpc  = ibm_is_vpc.management_vpc.id\n  zone = \"us-south-3\"\n  cidr = \"10.10.30.0/24\"\n}\n\nresource \"ibm_is_vpc_address_prefix\" \"management_vpe_zone_1_prefix\" {\n  name = \"slz-management-vpe-zone-1\"\n  vpc  = ibm_is_vpc.management_vpc.id\n  zone = \"us-south-1\"\n  cidr = \"10.20.10.0/24\"\n}\n\nresource \"ibm_is_vpc_address_prefix\" \"management_vpe_zone_2_prefix\" {\n  name = \"slz-management-vpe-zone-2\"\n  vpc  = ibm_is_vpc.management_vpc.id\n  zone = \"us-south-2\"\n  cidr = \"10.20.20.0/24\"\n}\n\nresource \"ibm_is_vpc_address_prefix\" \"management_vpe_zone_3_prefix\" {\n  name = \"slz-management-vpe-zone-3\"\n  vpc  = ibm_is_vpc.management_vpc.id\n  zone = \"us-south-3\"\n  cidr = \"10.20.30.0/24\"\n}\n\nresource \"ibm_is_vpc_address_prefix\" \"management_vpn_zone_1_prefix\" {\n  name = \"slz-management-vpn-zone-1\"\n  vpc  = ibm_is_vpc.management_vpc.id\n  zone = \"us-south-1\"\n  cidr = \"10.30.10.0/24\"\n}\n\nresource \"ibm_is_network_acl\" \"management_management_acl\" {\n  name           = \"slz-management-management-acl\"\n  vpc            = ibm_is_vpc.management_vpc.id\n  resource_group = ibm_resource_group.slz_management_rg.id\n  tags = [\n    \"slz\",\n    \"landing-zone\"\n  ]\n}\n\nresource \"ibm_is_network_acl_rule\" \"management_management_acl_rule_allow_ibm_inbound\" {\n  source      = \"161.26.0.0/16\"\n  network_acl = ibm_is_network_acl.management_management_acl.id\n  action      = \"allow\"\n  destination = \"10.0.0.0/8\"\n  direction   = \"inbound\"\n  name        = \"allow-ibm-inbound\"\n}\n\nresource \"ibm_is_network_acl_rule\" \"management_management_acl_rule_allow_all_network_inbound\" {\n  source      = \"10.0.0.0/8\"\n  network_acl = ibm_is_network_acl.management_management_acl.id\n  action      = \"allow\"\n  destination = \"10.0.0.0/8\"\n  direction   = \"inbound\"\n  name        = \"allow-all-network-inbound\"\n}\n\nresource \"ibm_is_network_acl_rule\" \"management_management_acl_rule_allow_all_outbound\" {\n  source      = \"0.0.0.0/0\"\n  network_acl = ibm_is_network_acl.management_management_acl.id\n  action      = \"allow\"\n  destination = \"0.0.0.0/0\"\n  direction   = \"outbound\"\n  name        = \"allow-all-outbound\"\n}\n\nresource \"ibm_is_subnet\" \"management_vsi_zone_1\" {\n  vpc             = ibm_is_vpc.management_vpc.id\n  name            = \"slz-management-vsi-zone-1\"\n  zone            = \"us-south-1\"\n  resource_group  = ibm_resource_group.slz_management_rg.id\n  network_acl     = ibm_is_network_acl.management_management_acl.id\n  ipv4_cidr_block = ibm_is_vpc_address_prefix.management_vsi_zone_1_prefix.cidr\n  tags = [\n    \"slz\",\n    \"landing-zone\"\n  ]\n}\n\nresource \"ibm_is_subnet\" \"management_vpn_zone_1\" {\n  vpc             = ibm_is_vpc.management_vpc.id\n  name            = \"slz-management-vpn-zone-1\"\n  zone            = \"us-south-1\"\n  resource_group  = ibm_resource_group.slz_management_rg.id\n  network_acl     = ibm_is_network_acl.management_management_acl.id\n  ipv4_cidr_block = ibm_is_vpc_address_prefix.management_vpn_zone_1_prefix.cidr\n  tags = [\n    \"slz\",\n    \"landing-zone\"\n  ]\n}\n\nresource \"ibm_is_subnet\" \"management_vsi_zone_2\" {\n  vpc             = ibm_is_vpc.management_vpc.id\n  name            = \"slz-management-vsi-zone-2\"\n  zone            = \"us-south-2\"\n  resource_group  = ibm_resource_group.slz_management_rg.id\n  network_acl     = ibm_is_network_acl.management_management_acl.id\n  ipv4_cidr_block = ibm_is_vpc_address_prefix.management_vsi_zone_2_prefix.cidr\n  tags = [\n    \"slz\",\n    \"landing-zone\"\n  ]\n}\n\nresource \"ibm_is_subnet\" \"management_vsi_zone_3\" {\n  vpc             = ibm_is_vpc.management_vpc.id\n  name            = \"slz-management-vsi-zone-3\"\n  zone            = \"us-south-3\"\n  resource_group  = ibm_resource_group.slz_management_rg.id\n  network_acl     = ibm_is_network_acl.management_management_acl.id\n  ipv4_cidr_block = ibm_is_vpc_address_prefix.management_vsi_zone_3_prefix.cidr\n  tags = [\n    \"slz\",\n    \"landing-zone\"\n  ]\n}\n\nresource \"ibm_is_subnet\" \"management_vpe_zone_1\" {\n  vpc             = ibm_is_vpc.management_vpc.id\n  name            = \"slz-management-vpe-zone-1\"\n  zone            = \"us-south-1\"\n  resource_group  = ibm_resource_group.slz_management_rg.id\n  network_acl     = ibm_is_network_acl.management_management_acl.id\n  ipv4_cidr_block = ibm_is_vpc_address_prefix.management_vpe_zone_1_prefix.cidr\n  tags = [\n    \"slz\",\n    \"landing-zone\"\n  ]\n}\n\nresource \"ibm_is_subnet\" \"management_vpe_zone_2\" {\n  vpc             = ibm_is_vpc.management_vpc.id\n  name            = \"slz-management-vpe-zone-2\"\n  zone            = \"us-south-2\"\n  resource_group  = ibm_resource_group.slz_management_rg.id\n  network_acl     = ibm_is_network_acl.management_management_acl.id\n  ipv4_cidr_block = ibm_is_vpc_address_prefix.management_vpe_zone_2_prefix.cidr\n  tags = [\n    \"slz\",\n    \"landing-zone\"\n  ]\n}\n\nresource \"ibm_is_subnet\" \"management_vpe_zone_3\" {\n  vpc             = ibm_is_vpc.management_vpc.id\n  name            = \"slz-management-vpe-zone-3\"\n  zone            = \"us-south-3\"\n  resource_group  = ibm_resource_group.slz_management_rg.id\n  network_acl     = ibm_is_network_acl.management_management_acl.id\n  ipv4_cidr_block = ibm_is_vpc_address_prefix.management_vpe_zone_3_prefix.cidr\n  tags = [\n    \"slz\",\n    \"landing-zone\"\n  ]\n}\n\n##############################################################################\n\n##############################################################################\n# Workload VPC\n##############################################################################\n\nresource \"ibm_is_vpc\" \"workload_vpc\" {\n  name                        = \"slz-workload-vpc\"\n  resource_group              = ibm_resource_group.slz_workload_rg.id\n  address_prefix_management   = \"manual\"\n  default_network_acl_name    = null\n  default_security_group_name = null\n  default_routing_table_name  = null\n  tags = [\n    \"slz\",\n    \"landing-zone\"\n  ]\n}\n\nresource \"ibm_is_vpc_address_prefix\" \"workload_vsi_zone_1_prefix\" {\n  name = \"slz-workload-vsi-zone-1\"\n  vpc  = ibm_is_vpc.workload_vpc.id\n  zone = \"us-south-1\"\n  cidr = \"10.40.10.0/24\"\n}\n\nresource \"ibm_is_vpc_address_prefix\" \"workload_vsi_zone_2_prefix\" {\n  name = \"slz-workload-vsi-zone-2\"\n  vpc  = ibm_is_vpc.workload_vpc.id\n  zone = \"us-south-2\"\n  cidr = \"10.50.10.0/24\"\n}\n\nresource \"ibm_is_vpc_address_prefix\" \"workload_vsi_zone_3_prefix\" {\n  name = \"slz-workload-vsi-zone-3\"\n  vpc  = ibm_is_vpc.workload_vpc.id\n  zone = \"us-south-3\"\n  cidr = \"10.60.10.0/24\"\n}\n\nresource \"ibm_is_vpc_address_prefix\" \"workload_vpe_zone_1_prefix\" {\n  name = \"slz-workload-vpe-zone-1\"\n  vpc  = ibm_is_vpc.workload_vpc.id\n  zone = \"us-south-1\"\n  cidr = \"10.40.20.0/24\"\n}\n\nresource \"ibm_is_vpc_address_prefix\" \"workload_vpe_zone_2_prefix\" {\n  name = \"slz-workload-vpe-zone-2\"\n  vpc  = ibm_is_vpc.workload_vpc.id\n  zone = \"us-south-2\"\n  cidr = \"10.50.20.0/24\"\n}\n\nresource \"ibm_is_vpc_address_prefix\" \"workload_vpe_zone_3_prefix\" {\n  name = \"slz-workload-vpe-zone-3\"\n  vpc  = ibm_is_vpc.workload_vpc.id\n  zone = \"us-south-3\"\n  cidr = \"10.60.20.0/24\"\n}\n\nresource \"ibm_is_network_acl\" \"workload_workload_acl\" {\n  name           = \"slz-workload-workload-acl\"\n  vpc            = ibm_is_vpc.workload_vpc.id\n  resource_group = ibm_resource_group.slz_workload_rg.id\n  tags = [\n    \"slz\",\n    \"landing-zone\"\n  ]\n}\n\nresource \"ibm_is_network_acl_rule\" \"workload_workload_acl_rule_allow_ibm_inbound\" {\n  source      = \"161.26.0.0/16\"\n  network_acl = ibm_is_network_acl.workload_workload_acl.id\n  action      = \"allow\"\n  destination = \"10.0.0.0/8\"\n  direction   = \"inbound\"\n  name        = \"allow-ibm-inbound\"\n}\n\nresource \"ibm_is_network_acl_rule\" \"workload_workload_acl_rule_allow_all_network_inbound\" {\n  source      = \"10.0.0.0/8\"\n  network_acl = ibm_is_network_acl.workload_workload_acl.id\n  action      = \"allow\"\n  destination = \"10.0.0.0/8\"\n  direction   = \"inbound\"\n  name        = \"allow-all-network-inbound\"\n}\n\nresource \"ibm_is_network_acl_rule\" \"workload_workload_acl_rule_allow_all_outbound\" {\n  source      = \"0.0.0.0/0\"\n  network_acl = ibm_is_network_acl.workload_workload_acl.id\n  action      = \"allow\"\n  destination = \"0.0.0.0/0\"\n  direction   = \"outbound\"\n  name        = \"allow-all-outbound\"\n}\n\nresource \"ibm_is_subnet\" \"workload_vsi_zone_1\" {\n  vpc             = ibm_is_vpc.workload_vpc.id\n  name            = \"slz-workload-vsi-zone-1\"\n  zone            = \"us-south-1\"\n  resource_group  = ibm_resource_group.slz_workload_rg.id\n  network_acl     = ibm_is_network_acl.workload_workload_acl.id\n  ipv4_cidr_block = ibm_is_vpc_address_prefix.workload_vsi_zone_1_prefix.cidr\n  tags = [\n    \"slz\",\n    \"landing-zone\"\n  ]\n}\n\nresource \"ibm_is_subnet\" \"workload_vsi_zone_2\" {\n  vpc             = ibm_is_vpc.workload_vpc.id\n  name            = \"slz-workload-vsi-zone-2\"\n  zone            = \"us-south-2\"\n  resource_group  = ibm_resource_group.slz_workload_rg.id\n  network_acl     = ibm_is_network_acl.workload_workload_acl.id\n  ipv4_cidr_block = ibm_is_vpc_address_prefix.workload_vsi_zone_2_prefix.cidr\n  tags = [\n    \"slz\",\n    \"landing-zone\"\n  ]\n}\n\nresource \"ibm_is_subnet\" \"workload_vsi_zone_3\" {\n  vpc             = ibm_is_vpc.workload_vpc.id\n  name            = \"slz-workload-vsi-zone-3\"\n  zone            = \"us-south-3\"\n  resource_group  = ibm_resource_group.slz_workload_rg.id\n  network_acl     = ibm_is_network_acl.workload_workload_acl.id\n  ipv4_cidr_block = ibm_is_vpc_address_prefix.workload_vsi_zone_3_prefix.cidr\n  tags = [\n    \"slz\",\n    \"landing-zone\"\n  ]\n}\n\nresource \"ibm_is_subnet\" \"workload_vpe_zone_1\" {\n  vpc             = ibm_is_vpc.workload_vpc.id\n  name            = \"slz-workload-vpe-zone-1\"\n  zone            = \"us-south-1\"\n  resource_group  = ibm_resource_group.slz_workload_rg.id\n  network_acl     = ibm_is_network_acl.workload_workload_acl.id\n  ipv4_cidr_block = ibm_is_vpc_address_prefix.workload_vpe_zone_1_prefix.cidr\n  tags = [\n    \"slz\",\n    \"landing-zone\"\n  ]\n}\n\nresource \"ibm_is_subnet\" \"workload_vpe_zone_2\" {\n  vpc             = ibm_is_vpc.workload_vpc.id\n  name            = \"slz-workload-vpe-zone-2\"\n  zone            = \"us-south-2\"\n  resource_group  = ibm_resource_group.slz_workload_rg.id\n  network_acl     = ibm_is_network_acl.workload_workload_acl.id\n  ipv4_cidr_block = ibm_is_vpc_address_prefix.workload_vpe_zone_2_prefix.cidr\n  tags = [\n    \"slz\",\n    \"landing-zone\"\n  ]\n}\n\nresource \"ibm_is_subnet\" \"workload_vpe_zone_3\" {\n  vpc             = ibm_is_vpc.workload_vpc.id\n  name            = \"slz-workload-vpe-zone-3\"\n  zone            = \"us-south-3\"\n  resource_group  = ibm_resource_group.slz_workload_rg.id\n  network_acl     = ibm_is_network_acl.workload_workload_acl.id\n  ipv4_cidr_block = ibm_is_vpc_address_prefix.workload_vpe_zone_3_prefix.cidr\n  tags = [\n    \"slz\",\n    \"landing-zone\"\n  ]\n}\n\n##############################################################################\n\n",
  "key_management.tf": "##############################################################################\n# Key Management Instance Slz Kms\n##############################################################################\n\nresource \"ibm_resource_instance\" \"slz_kms\" {\n  name              = \"slz-slz-kms\"\n  resource_group_id = ibm_resource_group.slz_service_rg.id\n  service           = \"kms\"\n  plan              = \"tiered-pricing\"\n  location          = \"us-south\"\n  tags = [\n    \"slz\",\n    \"landing-zone\"\n  ]\n}\n\nresource \"ibm_iam_authorization_policy\" \"slz_kms_server_protect_policy\" {\n  source_service_name         = \"server-protect\"\n  target_service_name         = \"kms\"\n  target_resource_instance_id = ibm_resource_instance.slz_kms.guid\n  description                 = \"Allow block storage volumes to be encrypted by Key Management instance.\"\n  roles = [\n    \"Reader\"\n  ]\n}\n\nresource \"ibm_iam_authorization_policy\" \"slz_kms_block_storage_policy\" {\n  source_service_name         = \"is\"\n  target_service_name         = \"kms\"\n  target_resource_instance_id = ibm_resource_instance.slz_kms.guid\n  description                 = \"Allow block storage volumes to be encrypted by Key Management instance.\"\n  source_resource_type        = \"share\"\n  roles = [\n    \"Reader\",\n    \"Authorization Delegator\"\n  ]\n}\n\nresource \"ibm_kms_key_rings\" \"slz_kms_slz_slz_ring_ring\" {\n  key_ring_id = \"slz-slz-kms-slz-slz-ring\"\n  instance_id = ibm_resource_instance.slz_kms.guid\n}\n\nresource \"ibm_kms_key\" \"slz_kms_slz_slz_key_key\" {\n  instance_id   = ibm_resource_instance.slz_kms.guid\n  key_name      = \"slz-slz-kms-slz-slz-key\"\n  standard_key  = false\n  key_ring_id   = ibm_kms_key_rings.slz_kms_slz_slz_ring_ring.key_ring_id\n  force_delete  = true\n  endpoint_type = \"public\"\n  depends_on = [\n    ibm_iam_authorization_policy.slz_kms_server_protect_policy,\n    ibm_iam_authorization_policy.slz_kms_block_storage_policy\n  ]\n}\n\nresource \"ibm_kms_key_policies\" \"slz_kms_slz_slz_key_key_policy\" {\n  instance_id   = ibm_resource_instance.slz_kms.guid\n  endpoint_type = \"public\"\n  key_id        = ibm_kms_key.slz_kms_slz_slz_key_key.key_id\n  rotation {\n    interval_month = 12\n  }\n  dual_auth_delete {\n    enabled = false\n  }\n}\n\nresource \"ibm_kms_key\" \"slz_kms_slz_atracker_key_key\" {\n  instance_id   = ibm_resource_instance.slz_kms.guid\n  key_name      = \"slz-slz-kms-slz-atracker-key\"\n  standard_key  = false\n  key_ring_id   = ibm_kms_key_rings.slz_kms_slz_slz_ring_ring.key_ring_id\n  force_delete  = true\n  endpoint_type = \"public\"\n  depends_on = [\n    ibm_iam_authorization_policy.slz_kms_server_protect_policy,\n    ibm_iam_authorization_policy.slz_kms_block_storage_policy\n  ]\n}\n\nresource \"ibm_kms_key_policies\" \"slz_kms_slz_atracker_key_key_policy\" {\n  instance_id   = ibm_resource_instance.slz_kms.guid\n  endpoint_type = \"public\"\n  key_id        = ibm_kms_key.slz_kms_slz_atracker_key_key.key_id\n  rotation {\n    interval_month = 12\n  }\n  dual_auth_delete {\n    enabled = false\n  }\n}\n\nresource \"ibm_kms_key\" \"slz_kms_slz_vsi_volume_key_key\" {\n  instance_id   = ibm_resource_instance.slz_kms.guid\n  key_name      = \"slz-slz-kms-slz-vsi-volume-key\"\n  standard_key  = false\n  key_ring_id   = ibm_kms_key_rings.slz_kms_slz_slz_ring_ring.key_ring_id\n  force_delete  = true\n  endpoint_type = \"public\"\n  depends_on = [\n    ibm_iam_authorization_policy.slz_kms_server_protect_policy,\n    ibm_iam_authorization_policy.slz_kms_block_storage_policy\n  ]\n}\n\nresource \"ibm_kms_key_policies\" \"slz_kms_slz_vsi_volume_key_key_policy\" {\n  instance_id   = ibm_resource_instance.slz_kms.guid\n  endpoint_type = \"public\"\n  key_id        = ibm_kms_key.slz_kms_slz_vsi_volume_key_key.key_id\n  rotation {\n    interval_month = 12\n  }\n  dual_auth_delete {\n    enabled = false\n  }\n}\n\n##############################################################################\n\n",
  "object_storage.tf": "##############################################################################\n# Object Storage Instance Atracker Cos\n##############################################################################\n\nresource \"random_string\" \"atracker_cos_random_suffix\" {\n  length  = 8\n  special = false\n  upper   = false\n}\n\nresource \"ibm_resource_instance\" \"atracker_cos_object_storage\" {\n  name              = \"slz-atracker-cos-object-storage-${random_string.atracker_cos_random_suffix.result}\"\n  resource_group_id = ibm_resource_group.slz_service_rg.id\n  service           = \"cloud-object-storage\"\n  location          = \"global\"\n  plan              = \"standard\"\n  tags = [\n    \"slz\",\n    \"landing-zone\"\n  ]\n}\n\nresource \"ibm_iam_authorization_policy\" \"atracker_cos_cos_to_slz_kms_kms_policy\" {\n  source_service_name         = \"cloud-object-storage\"\n  source_resource_instance_id = split(\":\", ibm_resource_instance.atracker_cos_object_storage.id)[7]\n  description                 = \"Allow COS instance to read from KMS instance\"\n  target_service_name         = \"kms\"\n  target_resource_instance_id = ibm_resource_instance.slz_kms.guid\n  roles = [\n    \"Reader\"\n  ]\n}\n\nresource \"ibm_cos_bucket\" \"atracker_cos_object_storage_atracker_bucket_bucket\" {\n  bucket_name          = \"slz-atracker-cos-atracker-bucket-${random_string.atracker_cos_random_suffix.result}\"\n  resource_instance_id = ibm_resource_instance.atracker_cos_object_storage.id\n  storage_class        = \"standard\"\n  endpoint_type        = \"public\"\n  force_delete         = true\n  region_location      = \"us-south\"\n  key_protect          = ibm_kms_key.slz_kms_slz_atracker_key_key.crn\n  depends_on = [\n    ibm_iam_authorization_policy.atracker_cos_cos_to_slz_kms_kms_policy\n  ]\n}\n\nresource \"ibm_resource_key\" \"atracker_cos_object_storage_key_cos_bind_key\" {\n  name                 = \"slz-atracker-cos-key-cos-bind-key-${random_string.atracker_cos_random_suffix.result}\"\n  resource_instance_id = ibm_resource_instance.atracker_cos_object_storage.id\n  role                 = \"Writer\"\n  tags = [\n    \"slz\",\n    \"landing-zone\"\n  ]\n}\n\n##############################################################################\n\n##############################################################################\n# Object Storage Instance Cos\n##############################################################################\n\nresource \"random_string\" \"cos_random_suffix\" {\n  length  = 8\n  special = false\n  upper   = false\n}\n\nresource \"ibm_resource_instance\" \"cos_object_storage\" {\n  name              = \"slz-cos-object-storage-${random_string.cos_random_suffix.result}\"\n  resource_group_id = ibm_resource_group.slz_service_rg.id\n  service           = \"cloud-object-storage\"\n  location          = \"global\"\n  plan              = \"standard\"\n  tags = [\n    \"slz\",\n    \"landing-zone\"\n  ]\n}\n\nresource \"ibm_iam_authorization_policy\" \"cos_cos_to_slz_kms_kms_policy\" {\n  source_service_name         = \"cloud-object-storage\"\n  source_resource_instance_id = split(\":\", ibm_resource_instance.cos_object_storage.id)[7]\n  description                 = \"Allow COS instance to read from KMS instance\"\n  target_service_name         = \"kms\"\n  target_resource_instance_id = ibm_resource_instance.slz_kms.guid\n  roles = [\n    \"Reader\"\n  ]\n}\n\nresource \"ibm_cos_bucket\" \"cos_object_storage_management_bucket_bucket\" {\n  bucket_name          = \"slz-cos-management-bucket-${random_string.cos_random_suffix.result}\"\n  resource_instance_id = ibm_resource_instance.cos_object_storage.id\n  storage_class        = \"standard\"\n  endpoint_type        = \"public\"\n  force_delete         = true\n  region_location      = \"us-south\"\n  key_protect          = ibm_kms_key.slz_kms_slz_slz_key_key.crn\n  depends_on = [\n    ibm_iam_authorization_policy.cos_cos_to_slz_kms_kms_policy\n  ]\n}\n\nresource \"ibm_cos_bucket\" \"cos_object_storage_workload_bucket_bucket\" {\n  bucket_name          = \"slz-cos-workload-bucket-${random_string.cos_random_suffix.result}\"\n  resource_instance_id = ibm_resource_instance.cos_object_storage.id\n  storage_class        = \"standard\"\n  endpoint_type        = \"public\"\n  force_delete         = true\n  region_location      = \"us-south\"\n  key_protect          = ibm_kms_key.slz_kms_slz_slz_key_key.crn\n  depends_on = [\n    ibm_iam_authorization_policy.cos_cos_to_slz_kms_kms_policy\n  ]\n}\n\n##############################################################################\n\n",
  "atracker.tf": "##############################################################################\n# Atracker Resources\n##############################################################################\n\nresource \"ibm_atracker_target\" \"slz_atracker_cos_target\" {\n  name        = \"slz-slz-atracker-cos\"\n  target_type = \"cloud_object_storage\"\n  region      = \"us-south\"\n\n  cos_endpoint {\n    endpoint   = \"s3.private.us-south.cloud-object-storage.appdomain.cloud\"\n    target_crn = ibm_resource_instance.atracker_cos_object_storage.id\n    bucket     = ibm_cos_bucket.atracker_cos_object_storage_atracker_bucket_bucket.bucket_name\n    api_key    = ibm_resource_key.atracker_cos_object_storage_key_cos_bind_key.credentials.apikey\n  }\n}\n\nresource \"ibm_atracker_route\" \"slz_atracker_cos_route\" {\n  name = \"slz-slz-atracker-cos-route\"\n\n  rules {\n    target_ids = [ibm_atracker_target.slz_atracker_cos_target.id]\n    locations  = [\"global\",\"us-south\"]\n  }\n}\n\n##############################################################################",
  "resource_groups.tf": "##############################################################################\n# Resource Groups\n##############################################################################\n\nresource \"ibm_resource_group\" \"slz_service_rg\" {\n  name = \"slz-slz-service-rg\"\n  tags = [\n    \"slz\",\n    \"landing-zone\"\n  ]\n}\n\nresource \"ibm_resource_group\" \"slz_management_rg\" {\n  name = \"slz-slz-management-rg\"\n  tags = [\n    \"slz\",\n    \"landing-zone\"\n  ]\n}\n\nresource \"ibm_resource_group\" \"slz_workload_rg\" {\n  name = \"slz-slz-workload-rg\"\n  tags = [\n    \"slz\",\n    \"landing-zone\"\n  ]\n}\n\n##############################################################################\n",
  "flow_logs.tf": "##############################################################################\n# Flow Logs Resources\n##############################################################################\n\nresource \"ibm_iam_authorization_policy\" \"flow_logs_to_cos_object_storage_policy\" {\n  source_service_name         = \"is\"\n  source_resource_type        = \"flow-log-collector\"\n  description                 = \"Allow flow logs write access cloud object storage instance\"\n  target_service_name         = \"cloud-object-storage\"\n  target_resource_instance_id = split(\":\", ibm_resource_instance.cos_object_storage.id)[7]\n  roles = [\n    \"Writer\"\n  ]\n}\n\nresource \"ibm_is_flow_log\" \"management_flow_log_collector\" {\n  name           = \"slz-management-vpc-logs\"\n  target         = ibm_is_vpc.management_vpc.id\n  active         = true\n  storage_bucket = ibm_cos_bucket.cos_object_storage_management_bucket_bucket.bucket_name\n  resource_group = ibm_resource_group.slz_management_rg.id\n  tags = [\n    \"slz\",\n    \"landing-zone\"\n  ]\n  depends_on = [\n    ibm_iam_authorization_policy.flow_logs_to_cos_object_storage_policy\n  ]\n}\n\nresource \"ibm_is_flow_log\" \"workload_flow_log_collector\" {\n  name           = \"slz-workload-vpc-logs\"\n  target         = ibm_is_vpc.workload_vpc.id\n  active         = true\n  storage_bucket = ibm_cos_bucket.cos_object_storage_management_bucket_bucket.bucket_name\n  resource_group = ibm_resource_group.slz_workload_rg.id\n  tags = [\n    \"slz\",\n    \"landing-zone\"\n  ]\n  depends_on = [\n    ibm_iam_authorization_policy.flow_logs_to_cos_object_storage_policy\n  ]\n}\n\n##############################################################################\n",
  "virtual_private_endpoints.tf": "##############################################################################\n# Management VPE Resources\n##############################################################################\n\nresource \"ibm_is_subnet_reserved_ip\" \"management_vpc_vpe_zone_1_subnet_vpe_ip\" {\n  subnet = ibm_is_subnet.management_vpe_zone_1.id\n}\n\nresource \"ibm_is_subnet_reserved_ip\" \"management_vpc_vpe_zone_2_subnet_vpe_ip\" {\n  subnet = ibm_is_subnet.management_vpe_zone_2.id\n}\n\nresource \"ibm_is_subnet_reserved_ip\" \"management_vpc_vpe_zone_3_subnet_vpe_ip\" {\n  subnet = ibm_is_subnet.management_vpe_zone_3.id\n}\n\nresource \"ibm_is_virtual_endpoint_gateway\" \"management_vpc_cos_vpe_gateway\" {\n  name           = \"slz-management-cos-vpe-gw\"\n  vpc            = ibm_is_vpc.management_vpc.id\n  resource_group = ibm_resource_group.slz_management_rg.id\n  tags = [\n    \"slz\",\n    \"landing-zone\"\n  ]\n  security_groups = [\n    ibm_is_security_group.management_vpc_management_vpe_sg_sg.id\n  ]\n  target {\n    crn           = \"crn:v1:bluemix:public:cloud-object-storage:global:::endpoint:s3.direct.us-south.cloud-object-storage.appdomain.cloud\"\n    resource_type = \"provider_cloud_service\"\n  }\n}\n\nresource \"ibm_is_virtual_endpoint_gateway_ip\" \"management_vpc_cos_gw_vpe_zone_1_gateway_ip\" {\n  gateway     = ibm_is_virtual_endpoint_gateway.management_vpc_cos_vpe_gateway.id\n  reserved_ip = ibm_is_subnet_reserved_ip.management_vpc_vpe_zone_1_subnet_vpe_ip.reserved_ip\n}\n\nresource \"ibm_is_virtual_endpoint_gateway_ip\" \"management_vpc_cos_gw_vpe_zone_2_gateway_ip\" {\n  gateway     = ibm_is_virtual_endpoint_gateway.management_vpc_cos_vpe_gateway.id\n  reserved_ip = ibm_is_subnet_reserved_ip.management_vpc_vpe_zone_2_subnet_vpe_ip.reserved_ip\n}\n\nresource \"ibm_is_virtual_endpoint_gateway_ip\" \"management_vpc_cos_gw_vpe_zone_3_gateway_ip\" {\n  gateway     = ibm_is_virtual_endpoint_gateway.management_vpc_cos_vpe_gateway.id\n  reserved_ip = ibm_is_subnet_reserved_ip.management_vpc_vpe_zone_3_subnet_vpe_ip.reserved_ip\n}\n\n##############################################################################\n\n##############################################################################\n# Workload VPE Resources\n##############################################################################\n\nresource \"ibm_is_subnet_reserved_ip\" \"workload_vpc_vpe_zone_1_subnet_vpe_ip\" {\n  subnet = ibm_is_subnet.workload_vpe_zone_1.id\n}\n\nresource \"ibm_is_subnet_reserved_ip\" \"workload_vpc_vpe_zone_2_subnet_vpe_ip\" {\n  subnet = ibm_is_subnet.workload_vpe_zone_2.id\n}\n\nresource \"ibm_is_subnet_reserved_ip\" \"workload_vpc_vpe_zone_3_subnet_vpe_ip\" {\n  subnet = ibm_is_subnet.workload_vpe_zone_3.id\n}\n\nresource \"ibm_is_virtual_endpoint_gateway\" \"workload_vpc_cos_vpe_gateway\" {\n  name           = \"slz-workload-cos-vpe-gw\"\n  vpc            = ibm_is_vpc.workload_vpc.id\n  resource_group = ibm_resource_group.slz_workload_rg.id\n  tags = [\n    \"slz\",\n    \"landing-zone\"\n  ]\n  security_groups = [\n    ibm_is_security_group.workload_vpc_workload_vpe_sg_sg.id\n  ]\n  target {\n    crn           = \"crn:v1:bluemix:public:cloud-object-storage:global:::endpoint:s3.direct.us-south.cloud-object-storage.appdomain.cloud\"\n    resource_type = \"provider_cloud_service\"\n  }\n}\n\nresource \"ibm_is_virtual_endpoint_gateway_ip\" \"workload_vpc_cos_gw_vpe_zone_1_gateway_ip\" {\n  gateway     = ibm_is_virtual_endpoint_gateway.workload_vpc_cos_vpe_gateway.id\n  reserved_ip = ibm_is_subnet_reserved_ip.workload_vpc_vpe_zone_1_subnet_vpe_ip.reserved_ip\n}\n\nresource \"ibm_is_virtual_endpoint_gateway_ip\" \"workload_vpc_cos_gw_vpe_zone_2_gateway_ip\" {\n  gateway     = ibm_is_virtual_endpoint_gateway.workload_vpc_cos_vpe_gateway.id\n  reserved_ip = ibm_is_subnet_reserved_ip.workload_vpc_vpe_zone_2_subnet_vpe_ip.reserved_ip\n}\n\nresource \"ibm_is_virtual_endpoint_gateway_ip\" \"workload_vpc_cos_gw_vpe_zone_3_gateway_ip\" {\n  gateway     = ibm_is_virtual_endpoint_gateway.workload_vpc_cos_vpe_gateway.id\n  reserved_ip = ibm_is_subnet_reserved_ip.workload_vpc_vpe_zone_3_subnet_vpe_ip.reserved_ip\n}\n\n##############################################################################\n",
  "security_groups.tf": "##############################################################################\n# Security Group Management VPE Sg\n##############################################################################\n\nresource \"ibm_is_security_group\" \"management_vpc_management_vpe_sg_sg\" {\n  name           = \"slz-management-management-vpe-sg-sg\"\n  vpc            = ibm_is_vpc.management_vpc.id\n  resource_group = ibm_resource_group.slz_management_rg.id\n  tags = [\n    \"slz\",\n    \"landing-zone\"\n  ]\n}\n\nresource \"ibm_is_security_group_rule\" \"management_vpc_management_vpe_sg_sg_rule_allow_ibm_inbound\" {\n  group     = ibm_is_security_group.management_vpc_management_vpe_sg_sg.id\n  remote    = \"161.26.0.0/16\"\n  direction = \"inbound\"\n}\n\nresource \"ibm_is_security_group_rule\" \"management_vpc_management_vpe_sg_sg_rule_allow_vpc_inbound\" {\n  group     = ibm_is_security_group.management_vpc_management_vpe_sg_sg.id\n  remote    = \"10.0.0.0/8\"\n  direction = \"inbound\"\n}\n\nresource \"ibm_is_security_group_rule\" \"management_vpc_management_vpe_sg_sg_rule_allow_vpc_outbound\" {\n  group     = ibm_is_security_group.management_vpc_management_vpe_sg_sg.id\n  remote    = \"10.0.0.0/8\"\n  direction = \"outbound\"\n}\n\nresource \"ibm_is_security_group_rule\" \"management_vpc_management_vpe_sg_sg_rule_allow_ibm_tcp_53_outbound\" {\n  group     = ibm_is_security_group.management_vpc_management_vpe_sg_sg.id\n  remote    = \"161.26.0.0/16\"\n  direction = \"outbound\"\n  tcp {\n    port_min = 53\n    port_max = 53\n  }\n}\n\nresource \"ibm_is_security_group_rule\" \"management_vpc_management_vpe_sg_sg_rule_allow_ibm_tcp_80_outbound\" {\n  group     = ibm_is_security_group.management_vpc_management_vpe_sg_sg.id\n  remote    = \"161.26.0.0/16\"\n  direction = \"outbound\"\n  tcp {\n    port_min = 80\n    port_max = 80\n  }\n}\n\nresource \"ibm_is_security_group_rule\" \"management_vpc_management_vpe_sg_sg_rule_allow_ibm_tcp_443_outbound\" {\n  group     = ibm_is_security_group.management_vpc_management_vpe_sg_sg.id\n  remote    = \"161.26.0.0/16\"\n  direction = \"outbound\"\n  tcp {\n    port_min = 443\n    port_max = 443\n  }\n}\n\n##############################################################################\n\n##############################################################################\n# Security Group Workload VPE Sg\n##############################################################################\n\nresource \"ibm_is_security_group\" \"workload_vpc_workload_vpe_sg_sg\" {\n  name           = \"slz-workload-workload-vpe-sg-sg\"\n  vpc            = ibm_is_vpc.workload_vpc.id\n  resource_group = ibm_resource_group.slz_workload_rg.id\n  tags = [\n    \"slz\",\n    \"landing-zone\"\n  ]\n}\n\nresource \"ibm_is_security_group_rule\" \"workload_vpc_workload_vpe_sg_sg_rule_allow_ibm_inbound\" {\n  group     = ibm_is_security_group.workload_vpc_workload_vpe_sg_sg.id\n  remote    = \"161.26.0.0/16\"\n  direction = \"inbound\"\n}\n\nresource \"ibm_is_security_group_rule\" \"workload_vpc_workload_vpe_sg_sg_rule_allow_vpc_inbound\" {\n  group     = ibm_is_security_group.workload_vpc_workload_vpe_sg_sg.id\n  remote    = \"10.0.0.0/8\"\n  direction = \"inbound\"\n}\n\nresource \"ibm_is_security_group_rule\" \"workload_vpc_workload_vpe_sg_sg_rule_allow_vpc_outbound\" {\n  group     = ibm_is_security_group.workload_vpc_workload_vpe_sg_sg.id\n  remote    = \"10.0.0.0/8\"\n  direction = \"outbound\"\n}\n\nresource \"ibm_is_security_group_rule\" \"workload_vpc_workload_vpe_sg_sg_rule_allow_ibm_tcp_53_outbound\" {\n  group     = ibm_is_security_group.workload_vpc_workload_vpe_sg_sg.id\n  remote    = \"161.26.0.0/16\"\n  direction = \"outbound\"\n  tcp {\n    port_min = 53\n    port_max = 53\n  }\n}\n\nresource \"ibm_is_security_group_rule\" \"workload_vpc_workload_vpe_sg_sg_rule_allow_ibm_tcp_80_outbound\" {\n  group     = ibm_is_security_group.workload_vpc_workload_vpe_sg_sg.id\n  remote    = \"161.26.0.0/16\"\n  direction = \"outbound\"\n  tcp {\n    port_min = 80\n    port_max = 80\n  }\n}\n\nresource \"ibm_is_security_group_rule\" \"workload_vpc_workload_vpe_sg_sg_rule_allow_ibm_tcp_443_outbound\" {\n  group     = ibm_is_security_group.workload_vpc_workload_vpe_sg_sg.id\n  remote    = \"161.26.0.0/16\"\n  direction = \"outbound\"\n  tcp {\n    port_min = 443\n    port_max = 443\n  }\n}\n\n##############################################################################\n",
  "vpn_gateways.tf": "##############################################################################\n# VPN Gateways\n##############################################################################\n\nresource \"ibm_is_vpn_gateway\" \"management_management_gateway_vpn_gw\" {\n  name           = \"slz-management-management-gateway-vpn-gw\"\n  subnet         = ibm_is_subnet.management_vpn_zone_1.id\n  resource_group = ibm_resource_group.slz_management_rg.id\n  tags = [\n    \"slz\",\n    \"landing-zone\"\n  ]\n  timeouts {\n    delete = \"1h\"\n  }\n}\n\n##############################################################################\n",
  "ssh_keys.tf": "##############################################################################\n# SSH Keys\n##############################################################################\n\nresource \"ibm_is_ssh_key\" \"slz_ssh_key\" {\n  name           = \"slz-slz-ssh-key\"\n  public_key     = var.slz_ssh_key_public_key\n  resource_group = ibm_resource_group.slz_management_rg.id\n  tags = [\n    \"slz\",\n    \"landing-zone\"\n  ]\n}\n\n##############################################################################\n",
  "transit_gateways.tf": "##############################################################################\n# Transit Gateway Transit Gateway\n##############################################################################\n\nresource \"ibm_tg_gateway\" \"transit_gateway\" {\n  name           = \"slz-transit-gateway\"\n  location       = \"us-south\"\n  global         = false\n  resource_group = ibm_resource_group.slz_service_rg.id\n  timeouts {\n    create = \"30m\"\n    delete = \"30m\"\n  }\n}\n\nresource \"ibm_tg_connection\" \"transit_gateway_to_management_connection\" {\n  gateway      = ibm_tg_gateway.transit_gateway.id\n  network_type = \"vpc\"\n  name         = \"slz-transit-gateway-management-hub-connection\"\n  network_id   = ibm_is_vpc.management_vpc.crn\n  timeouts {\n    create = \"30m\"\n    delete = \"30m\"\n  }\n}\n\nresource \"ibm_tg_connection\" \"transit_gateway_to_workload_connection\" {\n  gateway      = ibm_tg_gateway.transit_gateway.id\n  network_type = \"vpc\"\n  name         = \"slz-transit-gateway-workload-hub-connection\"\n  network_id   = ibm_is_vpc.workload_vpc.crn\n  timeouts {\n    create = \"30m\"\n    delete = \"30m\"\n  }\n}\n\n##############################################################################\n",
  "clusters.tf": "##############################################################################\n# Workload Cluster Cluster\n##############################################################################\n\nresource \"ibm_container_vpc_cluster\" \"workload_vpc_workload_cluster_cluster\" {\n  name                            = \"slz-workload-cluster-cluster\"\n  vpc_id                          = ibm_is_vpc.workload_vpc.id\n  resource_group_id               = ibm_resource_group.slz_workload_rg.id\n  flavor                          = \"bx2.16x64\"\n  worker_count                    = 2\n  kube_version                    = \"default\"\n  wait_till                       = \"IngressReady\"\n  disable_public_service_endpoint = false\n  entitlement                     = \"cloud_pak\"\n  cos_instance_crn                = ibm_resource_instance.cos_object_storage.crn\n  update_all_workers              = null\n  tags = [\n    \"slz\",\n    \"landing-zone\"\n  ]\n  zones {\n    name      = \"us-south-1\"\n    subnet_id = ibm_is_subnet.workload_vsi_zone_1.id\n  }\n  zones {\n    name      = \"us-south-2\"\n    subnet_id = ibm_is_subnet.workload_vsi_zone_2.id\n  }\n  zones {\n    name      = \"us-south-3\"\n    subnet_id = ibm_is_subnet.workload_vsi_zone_3.id\n  }\n  timeouts {\n    create = \"3h\"\n    update = \"3h\"\n    delete = \"2h\"\n  }\n  kms_config {\n    crk_id           = ibm_kms_key.slz_kms_slz_vsi_volume_key_key.key_id\n    instance_id      = ibm_resource_instance.slz_kms.guid\n    private_endpoint = false\n  }\n}\n\nresource \"ibm_container_vpc_worker_pool\" \"workload_vpc_workload_cluster_cluster_logging_pool_pool\" {\n  worker_pool_name  = \"slz-workload-cluster-cluster-logging-pool\"\n  vpc_id            = ibm_is_vpc.workload_vpc.id\n  resource_group_id = ibm_resource_group.slz_workload_rg.id\n  cluster           = ibm_container_vpc_cluster.workload_vpc_workload_cluster_cluster.id\n  flavor            = \"bx2.16x64\"\n  worker_count      = 2\n  entitlement       = \"cloud_pak\"\n  zones {\n    name      = \"us-south-1\"\n    subnet_id = ibm_is_subnet.workload_vsi_zone_1.id\n  }\n  zones {\n    name      = \"us-south-2\"\n    subnet_id = ibm_is_subnet.workload_vsi_zone_2.id\n  }\n  zones {\n    name      = \"us-south-3\"\n    subnet_id = ibm_is_subnet.workload_vsi_zone_3.id\n  }\n}\n\n##############################################################################\n",
  "virtual_servers.tf": "##############################################################################\n# Image Data Sources\n##############################################################################\n\ndata \"ibm_is_image\" \"ibm_ubuntu_18_04_6_minimal_amd64_2\" {\n  name = \"ibm-ubuntu-18-04-6-minimal-amd64-2\"\n}\n\n##############################################################################\n\n##############################################################################\n# Management VPC Management Server Deployment\n##############################################################################\n\nresource \"ibm_is_instance\" \"management_vpc_management_server_vsi_1_1\" {\n  name           = \"slz-management-management-server-vsi-zone-1-1\"\n  image          = data.ibm_is_image.ibm_ubuntu_18_04_6_minimal_amd64_2.id\n  profile        = \"cx2-4x8\"\n  resource_group = ibm_resource_group.slz_management_rg.id\n  vpc            = ibm_is_vpc.management_vpc.id\n  zone           = \"us-south-1\"\n  tags = [\n    \"slz\",\n    \"landing-zone\"\n  ]\n  primary_network_interface {\n    subnet = ibm_is_subnet.management_vsi_zone_1.id\n    security_groups = [\n      ibm_is_security_group.management_vpc_management_vpe_sg_sg.id\n    ]\n  }\n  boot_volume {\n    encryption = ibm_kms_key.slz_kms_slz_vsi_volume_key_key.crn\n  }\n  keys = [\n    ibm_is_ssh_key.slz_ssh_key.id\n  ]\n}\n\nresource \"ibm_is_instance\" \"management_vpc_management_server_vsi_1_2\" {\n  name           = \"slz-management-management-server-vsi-zone-1-2\"\n  image          = data.ibm_is_image.ibm_ubuntu_18_04_6_minimal_amd64_2.id\n  profile        = \"cx2-4x8\"\n  resource_group = ibm_resource_group.slz_management_rg.id\n  vpc            = ibm_is_vpc.management_vpc.id\n  zone           = \"us-south-1\"\n  tags = [\n    \"slz\",\n    \"landing-zone\"\n  ]\n  primary_network_interface {\n    subnet = ibm_is_subnet.management_vsi_zone_1.id\n    security_groups = [\n      ibm_is_security_group.management_vpc_management_vpe_sg_sg.id\n    ]\n  }\n  boot_volume {\n    encryption = ibm_kms_key.slz_kms_slz_vsi_volume_key_key.crn\n  }\n  keys = [\n    ibm_is_ssh_key.slz_ssh_key.id\n  ]\n}\n\nresource \"ibm_is_instance\" \"management_vpc_management_server_vsi_2_1\" {\n  name           = \"slz-management-management-server-vsi-zone-2-1\"\n  image          = data.ibm_is_image.ibm_ubuntu_18_04_6_minimal_amd64_2.id\n  profile        = \"cx2-4x8\"\n  resource_group = ibm_resource_group.slz_management_rg.id\n  vpc            = ibm_is_vpc.management_vpc.id\n  zone           = \"us-south-2\"\n  tags = [\n    \"slz\",\n    \"landing-zone\"\n  ]\n  primary_network_interface {\n    subnet = ibm_is_subnet.management_vsi_zone_2.id\n    security_groups = [\n      ibm_is_security_group.management_vpc_management_vpe_sg_sg.id\n    ]\n  }\n  boot_volume {\n    encryption = ibm_kms_key.slz_kms_slz_vsi_volume_key_key.crn\n  }\n  keys = [\n    ibm_is_ssh_key.slz_ssh_key.id\n  ]\n}\n\nresource \"ibm_is_instance\" \"management_vpc_management_server_vsi_2_2\" {\n  name           = \"slz-management-management-server-vsi-zone-2-2\"\n  image          = data.ibm_is_image.ibm_ubuntu_18_04_6_minimal_amd64_2.id\n  profile        = \"cx2-4x8\"\n  resource_group = ibm_resource_group.slz_management_rg.id\n  vpc            = ibm_is_vpc.management_vpc.id\n  zone           = \"us-south-2\"\n  tags = [\n    \"slz\",\n    \"landing-zone\"\n  ]\n  primary_network_interface {\n    subnet = ibm_is_subnet.management_vsi_zone_2.id\n    security_groups = [\n      ibm_is_security_group.management_vpc_management_vpe_sg_sg.id\n    ]\n  }\n  boot_volume {\n    encryption = ibm_kms_key.slz_kms_slz_vsi_volume_key_key.crn\n  }\n  keys = [\n    ibm_is_ssh_key.slz_ssh_key.id\n  ]\n}\n\nresource \"ibm_is_instance\" \"management_vpc_management_server_vsi_3_1\" {\n  name           = \"slz-management-management-server-vsi-zone-3-1\"\n  image          = data.ibm_is_image.ibm_ubuntu_18_04_6_minimal_amd64_2.id\n  profile        = \"cx2-4x8\"\n  resource_group = ibm_resource_group.slz_management_rg.id\n  vpc            = ibm_is_vpc.management_vpc.id\n  zone           = \"us-south-3\"\n  tags = [\n    \"slz\",\n    \"landing-zone\"\n  ]\n  primary_network_interface {\n    subnet = ibm_is_subnet.management_vsi_zone_3.id\n    security_groups = [\n      ibm_is_security_group.management_vpc_management_vpe_sg_sg.id\n    ]\n  }\n  boot_volume {\n    encryption = ibm_kms_key.slz_kms_slz_vsi_volume_key_key.crn\n  }\n  keys = [\n    ibm_is_ssh_key.slz_ssh_key.id\n  ]\n}\n\nresource \"ibm_is_instance\" \"management_vpc_management_server_vsi_3_2\" {\n  name           = \"slz-management-management-server-vsi-zone-3-2\"\n  image          = data.ibm_is_image.ibm_ubuntu_18_04_6_minimal_amd64_2.id\n  profile        = \"cx2-4x8\"\n  resource_group = ibm_resource_group.slz_management_rg.id\n  vpc            = ibm_is_vpc.management_vpc.id\n  zone           = \"us-south-3\"\n  tags = [\n    \"slz\",\n    \"landing-zone\"\n  ]\n  primary_network_interface {\n    subnet = ibm_is_subnet.management_vsi_zone_3.id\n    security_groups = [\n      ibm_is_security_group.management_vpc_management_vpe_sg_sg.id\n    ]\n  }\n  boot_volume {\n    encryption = ibm_kms_key.slz_kms_slz_vsi_volume_key_key.crn\n  }\n  keys = [\n    ibm_is_ssh_key.slz_ssh_key.id\n  ]\n}\n\n##############################################################################\n",
  "secrets_manager.tf": "##############################################################################\n# Key Management Authorizations\n##############################################################################\n\nresource \"ibm_iam_authorization_policy\" \"secrets_manager_to_slz_kms_kms_policy\" {\n  source_service_name         = \"secrets-manager\"\n  description                 = \"Allow Secets Manager instance to read from KMS instance\"\n  target_service_name         = \"kms\"\n  target_resource_instance_id = ibm_resource_instance.slz_kms.guid\n  roles = [\n    \"Reader\"\n  ]\n}\n\n##############################################################################\n\n##############################################################################\n# Secrets Manager Instances\n##############################################################################\n\nresource \"ibm_resource_instance\" \"secrets_manager_secrets_manager\" {\n  name              = \"slz-secrets-manager\"\n  location          = \"us-south\"\n  plan              = \"standard\"\n  service           = \"secrets-manager\"\n  resource_group_id = ibm_resource_group.slz_service_rg.id\n  parameters = {\n    kms_key = ibm_kms_key.slz_kms_slz_slz_key_key.crn\n  }\n  timeouts {\n    create = \"1h\"\n    delete = \"1h\"\n  }\n  tags = [\n    \"slz\",\n    \"landing-zone\"\n  ]\n  depends_on = [\n    ibm_iam_authorization_policy.secrets_manager_to_slz_kms_kms_policy\n  ]\n}\n\n##############################################################################\n",
  "appid.tf": "##############################################################################\n# Test Appid Resources\n##############################################################################\n\nresource \"ibm_resource_instance\" \"test_appid\" {\n  name              = \"slz-test-appid\"\n  resource_group_id = ibm_resource_group.slz_service_rg.id\n  service           = \"appid\"\n  plan              = \"graduated-tier\"\n  location          = \"us-south\"\n  tags = [\n    \"slz\",\n    \"landing-zone\"\n  ]\n}\n\nresource \"ibm_resource_key\" \"test_appid_key_test_key\" {\n  name                 = \"slz-test-appid-test-key\"\n  resource_instance_id = ibm_resource_instance.test_appid.id\n  role                 = \"Writer\"\n  tags = [\n    \"slz\",\n    \"landing-zone\"\n  ]\n}\n\nresource \"ibm_resource_key\" \"test_appid_key_test_key_2\" {\n  name                 = \"slz-test-appid-test-key-2\"\n  resource_instance_id = ibm_resource_instance.test_appid.id\n  role                 = \"Writer\"\n  tags = [\n    \"slz\",\n    \"landing-zone\"\n  ]\n}\n\n##############################################################################\n",
  "teleport_vsi.tf": "##############################################################################\n# Test Deployment Cloud Init\n##############################################################################\n\nlocals {\n  test_deployment_user_data = templatefile(\n    \"${path.module}/cloud-init.tpl\",\n    {\n      TELEPORT_LICENSE          = base64encode(tostring(\"TELEPORT_LICENSE\"))\n      HTTPS_CERT                = base64encode(tostring(\"HTTPS_CERT\"))\n      HTTPS_KEY                 = base64encode(tostring(\"HTTPS_KEY\"))\n      HOSTNAME                  = tostring(\"HOSTNAME\")\n      DOMAIN                    = tostring(\"DOMAIN\")\n      COS_BUCKET                = ibm_cos_bucket.atracker_cos_object_storage_atracker_bucket_bucket.bucket_name\n      COS_BUCKET_ENDPOINT       = ibm_cos_bucket.atracker_cos_object_storage_atracker_bucket_bucket.s3_endpoint_public\n      HMAC_ACCESS_KEY_ID        = ibm_resource_key.atracker_cos_object_storage_key_cos_bind_key.credentials[\"cos_hmac_keys.access_key_id\"]\n      HMAC_SECRET_ACCESS_KEY_ID = ibm_resource_key.atracker_cos_object_storage_key_cos_bind_key.credentials[\"cos_hmac_keys.secret_access_key\"]\n      APPID_CLIENT_ID           = ibm_resource_key.test_appid_test_key_key.credentials[\"clientId\"]\n      APPID_CLIENT_SECRET       = ibm_resource_key.test_appid_test_key_key.credentials[\"secret\"]\n      APPID_ISSUER_URL          = ibm_resource_key.test_appid_test_key_key.credentials[\"oauthServerUrl\"]\n      TELEPORT_VERSION          = tostring(\"TELEPORT_VERSION\")\n      MESSAGE_OF_THE_DAY        = tostring(\"MESSAGE_OF_THE_DAY\")\n      CLAIM_TO_ROLES            = [\n        {\n          email = \"email@email.email\"\n          roles = [\"role1\",\"role2\"]\n        },\n        {\n          email = \"email2@email.email\"\n          roles = [\"role1\",\"role2\"]\n        }\n      ]\n    }\n  )\n}\n\ndata \"template_cloudinit_config\" \"test_deployment_cloud_init\" {\n  base64_encode = false\n  gzip          = false\n  part {\n    content = local.test_deployment_user_data\n  }\n}\n\n##############################################################################\n\n##############################################################################\n# Test Deployment Teleport Instance\n##############################################################################\n\nresource \"ibm_is_instance\" \"test_deployment_teleport_vsi\" {\n  name           = \"slz-test-deployment-teleport-vsi\"\n  image          = data.ibm_is_image.ibm_ubuntu_18_04_6_minimal_amd64_2.id\n  profile        = \"cx2-4x8\"\n  resource_group = ibm_resource_group.slz_management_rg.id\n  vpc            = ibm_is_vpc.management_vpc.id\n  zone           = \"us-south-1\"\n  user_data      = data.template_cloudinit_config.test_deployment_cloud_init.rendered\n  tags = [\n    \"slz\",\n    \"landing-zone\"\n  ]\n  primary_network_interface {\n    subnet = ibm_is_subnet.management_vsi_zone_1.id\n    security_groups = [\n      ibm_is_security_group.management_vpc_management_vpe_sg_sg.id\n    ]\n  }\n  boot_volume {\n    encryption = ibm_kms_key.slz_kms_slz_vsi_volume_key_key.crn\n  }\n  keys = [\n    ibm_is_ssh_key.slz_ssh_key.id\n  ]\n}\n\n##############################################################################\n\n##############################################################################\n# Redirect Urls\n##############################################################################\n\nresource \"ibm_appid_redirect_urls\" \"test_deployment_appid_urls\" {\n  tenant_id = ibm_resource_instance.test_appid.guid\n  urls = [\n    \"https://slz-test-deployment-teleport-vsi.DOMAIN:3080/v1/webapi/oidc/callback\"\n  ]\n}\n\n##############################################################################\n",
  "scc.tf": "##############################################################################\n# Security and Compliance Center Credentials\n##############################################################################\n\nresource \"ibm_scc_posture_credential\" \"scc_credentials\" {\n  description = \"scc posture credential description\"\n  enabled     = true\n  name        = \"scc-posture-credential\"\n  type        = \"ibm_cloud\"\n  purpose     = \"discovery_fact_collection_remediation\"\n  display_fields {\n    ibm_api_key = var.ibmcloud_api_key\n  }\n  group {\n    id         = \"scc_group_id\"\n    passphrase = \"scc_group_passphrase\"\n  }\n}\n\n##############################################################################\n\n##############################################################################\n# Security and Compliance Center\n##############################################################################\n\nresource \"ibm_scc_account_settings\" \"ibm_scc_account_settings_instance\" {\n  location {\n    location_id = \"us\"\n  }\n}\n\nresource \"ibm_scc_posture_collector\" \"collector\" {\n  description = \"scc collector\"\n  is_public   = true\n  managed_by  = \"ibm\"\n  name        = \"slz-scc-collector\"\n}\n\nresource \"ibm_scc_posture_scope\" \"scc_scope\" {\n  credential_id   = ibm_scc_posture_credential.scc_credentials.id\n  credential_type = \"ibm\"\n  description     = \"scc scope\"\n  name            = \"slz-scc-scope\"\n  collector_ids = [\n    ibm_scc_posture_collector.collector.id\n  ]\n}\n\n##############################################################################\n",
  "event_streams.tf": "##############################################################################\n# Event Streams\n##############################################################################\n\nresource \"ibm_resource_instance\" \"event_streams_es\" {\n  name              = \"slz-event-streams\"\n  service           = \"messagehub\"\n  plan              = \"enterprise-3nodes-2tb\"\n  location          = \"us-south\"\n  resource_group_id = ibm_resource_group.slz_service_rg.id\n\n  parameters = {\n    service-endpoints    = \"private\"\n    private_ip_allowlist = \"[10.0.0.0/32,10.0.0.1/32]\"\n    throughput           = \"150\"\n    storage_size         = \"2048\"\n  }\n\n  timeouts {\n    create = \"3h\"\n    update = \"1h\"\n    delete = \"1h\"\n  }\n}\n\n##############################################################################\n",
  "load_balancers.tf": "##############################################################################\n# Lb 1 Load Balancer\n##############################################################################\n\nresource \"ibm_is_lb\" \"lb_1_load_balancer\" {\n  name            = \"slz-lb-1-lb\"\n  type            = \"public\"\n  resource_group  = ibm_resource_group.slz_management_rg.id\n  tags = [\n  \"slz\",\n  \"landing-zone\"\n  ]\n\n  security_groups = [\n    ibm_is_security_group.management_vpc_management_vpe_sg_sg.id\n  ]\n\n  subnets = [\n    ibm_is_subnet.management_vsi_zone_1.id,\n    ibm_is_subnet.management_vsi_zone_2.id,\n    ibm_is_subnet.management_vsi_zone_3.id\n  ]\n}\n\nresource \"ibm_is_lb_pool\" \"lb_1_load_balancer_pool\" {\n  lb                                  = ibm_is_lb.lb_1_load_balancer.id\n  name                                = \"slz-lb-1-lb-pool\"\n  algorithm                           = \"round_robin\"\n  protocol                            = \"tcp\"\n  health_delay                        = 60\n  health_retries                      = 5\n  health_timeout                      = 30\n  health_type                         = \"https\"\n  proxy_protocol                      = \"v1\"\n  session_persistence_type            = \"app_cookie\"\n  session_persistence_app_cookie_name = \"cookie1\"\n}\n\nresource \"ibm_is_lb_pool_member\" \"lb_1_management_server_management_vpc_management_server_vsi_1_1_pool_member\" {\n  port           = 80\n  lb             = ibm_is_lb.lb_1_load_balancer.id\n  pool           = element(split(\"/\", ibm_is_lb_pool.lb_1_load_balancer_pool.id), 1)\n  target_address = ibm_is_instance.management_vpc_management_server_vsi_1_1.primary_network_interface.0.primary_ip.0.address\n}\n\nresource \"ibm_is_lb_pool_member\" \"lb_1_management_server_management_vpc_management_server_vsi_1_2_pool_member\" {\n  port           = 80\n  lb             = ibm_is_lb.lb_1_load_balancer.id\n  pool           = element(split(\"/\", ibm_is_lb_pool.lb_1_load_balancer_pool.id), 1)\n  target_address = ibm_is_instance.management_vpc_management_server_vsi_1_2.primary_network_interface.0.primary_ip.0.address\n}\n\nresource \"ibm_is_lb_pool_member\" \"lb_1_management_server_management_vpc_management_server_vsi_2_1_pool_member\" {\n  port           = 80\n  lb             = ibm_is_lb.lb_1_load_balancer.id\n  pool           = element(split(\"/\", ibm_is_lb_pool.lb_1_load_balancer_pool.id), 1)\n  target_address = ibm_is_instance.management_vpc_management_server_vsi_2_1.primary_network_interface.0.primary_ip.0.address\n}\n\nresource \"ibm_is_lb_pool_member\" \"lb_1_management_server_management_vpc_management_server_vsi_2_2_pool_member\" {\n  port           = 80\n  lb             = ibm_is_lb.lb_1_load_balancer.id\n  pool           = element(split(\"/\", ibm_is_lb_pool.lb_1_load_balancer_pool.id), 1)\n  target_address = ibm_is_instance.management_vpc_management_server_vsi_2_2.primary_network_interface.0.primary_ip.0.address\n}\n\nresource \"ibm_is_lb_pool_member\" \"lb_1_management_server_management_vpc_management_server_vsi_3_1_pool_member\" {\n  port           = 80\n  lb             = ibm_is_lb.lb_1_load_balancer.id\n  pool           = element(split(\"/\", ibm_is_lb_pool.lb_1_load_balancer_pool.id), 1)\n  target_address = ibm_is_instance.management_vpc_management_server_vsi_3_1.primary_network_interface.0.primary_ip.0.address\n}\n\nresource \"ibm_is_lb_pool_member\" \"lb_1_management_server_management_vpc_management_server_vsi_3_2_pool_member\" {\n  port           = 80\n  lb             = ibm_is_lb.lb_1_load_balancer.id\n  pool           = element(split(\"/\", ibm_is_lb_pool.lb_1_load_balancer_pool.id), 1)\n  target_address = ibm_is_instance.management_vpc_management_server_vsi_3_2.primary_network_interface.0.primary_ip.0.address\n}\n\nresource \"ibm_is_lb_listener\" \"lb_1_listener\" {\n  lb               = ibm_is_lb.lb_1_load_balancer.id\n  default_pool     = ibm_is_lb_pool.lb_1_load_balancer_pool.id\n  port             = 443\n  protocol         = \"https\"\n  connection_limit = 2\n\n  depends_on = [\n    ibm_is_lb_pool_member.lb_1_management_server_management_vpc_management_server_vsi_1_1_pool_member.id,\n    ibm_is_lb_pool_member.lb_1_management_server_management_vpc_management_server_vsi_1_2_pool_member.id,\n    ibm_is_lb_pool_member.lb_1_management_server_management_vpc_management_server_vsi_2_1_pool_member.id,\n    ibm_is_lb_pool_member.lb_1_management_server_management_vpc_management_server_vsi_2_2_pool_member.id,\n    ibm_is_lb_pool_member.lb_1_management_server_management_vpc_management_server_vsi_3_1_pool_member.id,\n    ibm_is_lb_pool_member.lb_1_management_server_management_vpc_management_server_vsi_3_2_pool_member.id\n  ]\n}\n\n##############################################################################\n",
  "cloud-init.tpl":"#cloud-config                                                                                      \n# This file is used to install teleport on a bastion host, configure teleport with App ID, and    \n# configure teleport with a COS instance.                                                         \n# https://github.com/cloud-native-toolkit/terraform-vsi-bastion-teleport/blob/main/cloud-init.tpl \npackages:\n  - tar\nwrite_files:\n    # writing teleport license\n  - path: /root/license.pem\n    permissions: \"0644\"\n    encoding: base64\n    content: ${TELEPORT_LICENSE}\n\n    # writing https cert\n  - path: /root/ca.crt\n    permissions: \"0644\"\n    encoding: base64\n    content: ${HTTPS_CERT}\n\n    # writing https key\n  - path: /root/ca.key\n    permissions: \"0644\"\n    encoding: base64\n    content: ${HTTPS_KEY}\n\n    # writing teleport roles\n  - path: /root/roles.yaml\n    permissions: \"0644\"\n    content: |\n      # Example role\n      # Add any additional ones to the end\n      kind: \"role\"\n      version: \"v3\"\n      metadata:\n        name: \"teleport-admin\"\n      spec:\n        options:\n          max_connections: 3\n          cert_format: standard\n          client_idle_timeout: 15m\n          disconnect_expired_cert: no\n          enhanced_recording:\n          - command\n          - network\n          forward_agent: true\n          max_session_ttl: 1h\n          port_forwarding: false\n        allow:\n          logins: [root]\n          node_labels:\n            \"*\": \"*\"\n          rules:\n          - resources: [\"*\"]\n            verbs: [\"*\"]\n      ---\n\n    # writing oidc file to use App ID for authentication\n  - path: /root/oidc.yaml\n    permissions: \"0644\"\n    content: |\n      #oidc connector\n      kind: oidc\n      version: v2\n      metadata:\n        name: appid\n      spec:\n        redirect_url: \"https://${HOSTNAME}.${DOMAIN}:3080/v1/webapi/oidc/callback\"\n        client_id: \"${APPID_CLIENT_ID}\"\n        display: AppID\n        client_secret: \"${APPID_CLIENT_SECRET}\"\n        issuer_url: \"${APPID_ISSUER_URL}\"\n        scope: [\"openid\", \"email\"]\n        claims_to_roles: \n         %{~ for claims in CLAIM_TO_ROLES ~}\n          - {claim: \"email\", value: \"${claims.email}\", roles: ${jsonencode(claims.roles)}}\n         %{~ endfor ~}\n\n    # writing configuration for teleport\n  - path: /etc/teleport.yaml\n    permissions: \"0644\"\n    content: |\n      #teleport.yaml\n      teleport:\n        nodename: ${HOSTNAME}.${DOMAIN}\n        data_dir: /var/lib/teleport\n        log:\n          output: stderr\n          severity: DEBUG \n        storage:\n          audit_sessions_uri: \"s3://${COS_BUCKET}?endpoint=${COS_BUCKET_ENDPOINT}&region=ibm\"\n\n      auth_service:\n        enabled: true\n        listen_addr: 0.0.0.0:3025\n        authentication:\n          type: oidc\n          local_auth: false\n        license_file: /var/lib/teleport/license.pem\n        message_of_the_day: ${MESSAGE_OF_THE_DAY}\n\n      ssh_service:\n        enabled: true\n        commands:\n        - name: hostname\n          command: [hostname]\n          period: 1m0s\n        - name: arch\n          command: [uname, -p]\n          period: 1h0m0s\n\n      proxy_service:\n        enabled: true\n        listen_addr: 0.0.0.0:3023\n        web_listen_addr: 0.0.0.0:3080\n        tunnel_listen_addr: 0.0.0.0:3024\n        https_cert_file: /var/lib/teleport/ca.crt\n        https_key_file: /var/lib/teleport/ca.key\n\n    # writing script to start teleport\n  - path: /etc/systemd/system/teleport.service\n    permissions: \"0644\"\n    content: |\n      [Unit]\n      Description=Teleport Service\n      After=network.target\n\n      [Service]\n      Type=simple\n      Restart=on-failure\n      Environment=AWS_ACCESS_KEY_ID=${HMAC_ACCESS_KEY_ID}\n      Environment=AWS_SECRET_ACCESS_KEY=${HMAC_SECRET_ACCESS_KEY_ID}\n      ExecStart=/usr/local/bin/teleport start --config=/etc/teleport.yaml --pid-file=/run/teleport.pid\n      ExecReload=/bin/kill -HUP $MAINPID\n      PIDFile=/run/teleport.pid\n\n      [Install]\n      WantedBy=multi-user.target\n\n    # writing script to install teleport on bastion host\n  - path: /root/install.sh\n    permissions: \"0755\"\n    content: |\n      #!/bin/bash\n      set -x\n      setup_path=\"/root\"\n      teleport_file=\"teleport-ent-v${TELEPORT_VERSION}-linux-amd64-bin.tar.gz\"\n      teleport_url=\"https://get.gravitational.com/$teleport_file\"\n\n      #retrieve and extract teleport\n      cd $setup_path\n      curl --connect-timeout 30 --retry 15 --retry-delay 10 $teleport_url --output $teleport_file\n      tar -xvzf $teleport_file\n\n      #Copy files over\n      cp $setup_path/teleport-ent/teleport /usr/local/bin/\n      cp $setup_path/teleport-ent/tctl /usr/local/bin/\n      cp $setup_path/teleport-ent/tsh /usr/local/bin/\n\n      #Make the /var/lib/teleport directory\n      TELEPORT_CONFIG_PATH=\"/var/lib/teleport\"\n      mkdir $TELEPORT_CONFIG_PATH\n\n      #copy files for /root to /var/lib/\n      cp $setup_path/license.pem $TELEPORT_CONFIG_PATH\n      cp $setup_path/ca.crt $TELEPORT_CONFIG_PATH\n      cp $setup_path/ca.key $TELEPORT_CONFIG_PATH\n\n      sudo systemctl daemon-reload\n      sudo systemctl start teleport\n      sudo systemctl enable teleport\n\n      # allow ports for firewall \n      # check if firewalld is used\n      firewall-cmd -h \n      rc=$?\n      if [[ $rc -eq 0 ]]; then\n         systemctl stop firewalld\n         sudo firewall-offline-cmd --zone=public --add-port=3023/tcp\n         #sudo firewall-cmd --permanent --zone=public --add-port=3023/tcp\n         sudo firewall-offline-cmd --zone=public --add-port=3080/tcp\n         #sudo firewall-cmd --permanent --zone=public --add-port=3080/tcp\n         systemctl start firewalld\n      fi\n\n      # check if firewalld is used\n      ufw version\n      rc=$?\n      if [[ $rc -eq 0 ]]; then\n         ufw allow 3023,3080/tcp\n      fi\n\n      #distro=$(awk '/DISTRIB_ID=/' /etc/*-release | sed 's/DISTRIB_ID=//' | tr '[:upper:]' '[:lower:]')\n      #echo $distro\n      #if [[ $distro == \"ubuntu\" ]]; then\n      #    ufw allow 3023,3080/tcp\n      #fi\n\n      sleep 120\n      ## Apply the oidc and role configuration\n      tctl create $setup_path/roles.yaml\n      tctl create $setup_path/oidc.yaml\n\nruncmd:\n    # running the script to install teleport on bastion host\n  - |\n    set -x\n    (\n      while [ ! -f /root/install.sh ]; do\n        sleep 10\n      done\n      /root/install.sh\n    ) &"
}
